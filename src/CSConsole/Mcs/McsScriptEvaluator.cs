#if !NET472
using HarmonyLib;
using Mono.CSharp;
using UnityExplorer.Config;

// Thanks to ManlyMarco for this

namespace UnityExplorer.CSConsole
{
    public class McsScriptEvaluator : Evaluator, IDisposable
    {
        private static readonly FieldInfo EvaluatorImporter = AccessTools.Field(typeof(Evaluator), "importer");

        internal TextWriter _textWriter;
        internal static StreamReportPrinter _reportPrinter;

        static McsScriptEvaluator()
        {
            ExplorerCore.Harmony.PatchAll(typeof(McsScriptEvaluator));
        }

        public McsScriptEvaluator(TextWriter tw) : base(BuildContext(tw))
        {
            ReflectionImporter importer = (ReflectionImporter)EvaluatorImporter.GetValue(this);
            importer.IgnorePrivateMembers = false;
            importer.IgnoreCompilerGeneratedField = true;
            _textWriter = tw;

            ImportAppdomainAssemblies();
            AppDomain.CurrentDomain.AssemblyLoad += OnAssemblyLoad;
        }

        [HarmonyPrefix]
        [HarmonyPatch(typeof(MemberSpec), nameof(MemberSpec.IsAccessible), typeof(IMemberContext))]
        public static bool prefix_IsAccessible(IMemberContext ctx, ref bool __result)
        {
            __result = true;
            return false;
        }

        public void Dispose()
        {
            AppDomain.CurrentDomain.AssemblyLoad -= OnAssemblyLoad;
            _textWriter.Dispose();
        }

        private void OnAssemblyLoad(object sender, AssemblyLoadEventArgs args)
        {
            Reference(args.LoadedAssembly);
        }

        private void Reference(Assembly asm)
        {
            string name = asm.GetName().Name;

            if (name == "completions") // ignore assemblies generated by mcs' autocomplete.
                return;

            foreach (string blacklisted in ConfigManager.CSConsole_Assembly_Blacklist.Value.Split(';'))
            {
                string bl = blacklisted;
                if (bl.EndsWith(".dll", StringComparison.OrdinalIgnoreCase))
                    bl = blacklisted.Substring(0, bl.Length - 4);
                if (string.Equals(bl, name, StringComparison.OrdinalIgnoreCase))
                    return;
            }

            ReferenceAssembly(asm);
        }

        private static CompilerContext BuildContext(TextWriter tw)
        {
            _reportPrinter = new StreamReportPrinter(tw);

            CompilerSettings settings = new()
            {
                Version = LanguageVersion.Experimental,
                Optimize = false,
                GenerateDebugInfo = true,
                StdLib = false,
                Target = Target.Library,
                WarningLevel = 0,
                Unsafe = true,
                EnhancedWarnings = false
            };

            return new CompilerContext(settings, _reportPrinter);
        }

        private void ImportAppdomainAssemblies()
        {
            foreach (Assembly assembly in AppDomain.CurrentDomain.GetAssemblies())
            {
                try
                {
                    Reference(assembly);
                }
                catch // (Exception ex)
                {
                    //ExplorerCore.LogWarning($"Excepting referencing '{name}': {ex.GetType()}.{ex.Message}");
                }
            }
        }
    }
}
#endif
